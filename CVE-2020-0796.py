#!/usr/bin/env python
#CVE-2020-0796 Windows SMBv3 RCE
# Some references:
# https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/adv200005

import socket
import sys
import struct
sys.dont_write_bytecode = True

def exploit(ip,port):
    try:
        pkt = b'\x00\x00\x00\xc0\xfeSMB@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x08\x00\x01\x00\x00\x00\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00x\x00\x00\x00\x02\x00\x00\x00\x02\x02\x10\x02"\x02$\x02\x00\x03\x02\x03\x10\x03\x11\x03\x00\x00\x00\x00\x01\x00&\x00\x00\x00\x00\x00\x01\x00 \x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\n\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'
        sock = socket.socket(socket.AF_INET)
        sock.connect((ip,int(port)))
        sock.send(pkt)
        nb, = struct.unpack(">I", sock.recv(4))
        res = sock.recv(nb)
        if not res[68:70] == b"\x11\x03":
            return None
        if not res[70:72] == b"\x02\x00":
            return None
        else:
            return True
            sys.exit()
    except  Exception,msg:
        print msg
        return None

def Check_Vuln(ip,port):
    return exploit(ip,port)


IP = '127.0.0.1'
PORT = 445
if __name__ == '__main__':
    Check_Vuln(IP, PORT)
